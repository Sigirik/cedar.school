{% extends 'base.html' %}

{% block content %}
  <h2>Создание реального урока</h2>
    {% if form.errors %}
      <ul class="errorlist">
        {% for field in form %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}</strong>: {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  <form method="post">
    {% csrf_token %}

    <p>{{ form.date.label_tag }} {{ form.date }}</p>
    <p>{{ form.subject.label_tag }} {{ form.subject }}</p>
    <p>{{ form.teacher.label_tag }} {{ form.teacher }}</p>
    <p>{{ form.grade.label_tag }} {{ form.grade }}</p>
    <p>{{ form.start_time.label_tag }} {{ form.start_time }}</p>
    <p>{{ form.duration_minutes.label_tag }} {{ form.duration_minutes }}</p>
    <p>{{ form.topic.label_tag }} {{ form.topic }}</p>

    <p>
      <label for="id_template_lesson">Шаблон урока:</label>
      <select name="template_lesson" id="id_template_lesson">
        <option value="">---------</option>
        {% for lesson in form.fields.template_lesson.queryset %}
          <option value="{{ lesson.id }}" data-day="{{ lesson.day_of_week }}">{{ lesson }}</option>
        {% endfor %}
      </select>

      <button type="button" id="reset-template" style="display: none;" title="Сбросить шаблон">↺</button>
    </p>

    <button type="submit">Сохранить</button>
  </form>

  <script>
    const dateInput = document.querySelector('input[name="date"]');
    const templateSelect = document.querySelector('select[name="template_lesson"]');
    const resetButton = document.getElementById('reset-template');

    if (dateInput && templateSelect && resetButton) {
      const originalOptions = Array.from(templateSelect.options);

      function disableTemplateSelect() {
        templateSelect.innerHTML = '';
        const option = document.createElement('option');
        option.text = 'Сначала выберите дату';
        option.value = '';
        templateSelect.appendChild(option);
        templateSelect.disabled = true;
        resetButton.style.display = 'none';
      }

      disableTemplateSelect();

      dateInput.addEventListener('change', function () {
        const selectedDate = new Date(this.value);
        if (isNaN(selectedDate)) {
          disableTemplateSelect();
          return;
        }

        const weekday = selectedDate.getDay();
        const djangoWeekday = (weekday + 6) % 7;

        templateSelect.innerHTML = '';
        const filtered = originalOptions.filter(opt => {
          return opt.dataset.day == djangoWeekday || opt.value === '';
        });

        if (filtered.length > 1) {
          filtered.forEach(opt => templateSelect.appendChild(opt));
          templateSelect.disabled = false;
        } else {
          const option = document.createElement('option');
          option.text = 'Нет шаблонов для выбранной даты';
          option.value = '';
          templateSelect.appendChild(option);
          templateSelect.disabled = true;
        }

        // при смене даты сбрасываем шаблон
        templateSelect.value = '';
        resetButton.style.display = 'none';
      });

      templateSelect.addEventListener('change', function () {
        const lessonId = this.value;
        resetButton.style.display = lessonId ? 'inline-block' : 'none';

        if (!lessonId) return;

        fetch(`/schedule/api/template-lesson/${lessonId}/`)
          .then(response => response.json())
          .then(data => {
            document.querySelector('select[name="subject"]').value = data.subject;
            document.querySelector('select[name="teacher"]').value = data.teacher;
            document.querySelector('select[name="grade"]').value = data.grade;
            document.querySelector('input[name="start_time"]').value = data.start_time;
            document.querySelector('input[name="duration_minutes"]').value = data.duration_minutes;
          })
          .catch(error => {
            console.error("Ошибка при получении шаблона:", error);
          });
      });

      resetButton.addEventListener('click', function () {
        templateSelect.value = '';
        resetButton.style.display = 'none';
        document.querySelector('select[name="subject"]').value = '';
        document.querySelector('select[name="teacher"]').value = '';
        document.querySelector('select[name="grade"]').value = '';
        document.querySelector('input[name="start_time"]').value = '';
        document.querySelector('input[name="duration_minutes"]').value = '';
      });
    }
  </script>

{% endblock %}
