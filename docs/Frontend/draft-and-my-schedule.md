# Frontend API Guide: Draft (Template Week) & My Schedule

Этот документ описывает HTTP‑эндпоинты для работы фронтенда с **черновиками недельного шаблона расписания** (Draft / TemplateWeekDraft) и чтением **личного расписания** (My Schedule).

> База URL: `/api/`  
> Аутентификация: cookie/session (DRF). Все эндпоинты требуют авторизации.

---

## Содержание
- [Черновики недельного шаблона (Draft)](#черновики-недельного-шаблона-draft)
  - [Модель данных черновика](#модель-данных-черновика)
  - [Получить/создать черновик пользователя](#получитьсоздать-черновик-пользователя)
  - [Создать черновик из активного/указанного шаблона](#создать-черновик-из-активногоуказанного-шаблона)
  - [Создать пустой черновик](#создать-пустой-черновик)
  - [Обновить черновик](#обновить-черновик)
  - [Проверить черновик на коллизии (без коммита)](#проверить-черновик-на-коллизии-без-коммита)
  - [Проверить существование черновика](#проверить-существование-черновика)
  - [Коммит черновика → публикация активной недели](#коммит-черновика--публикация-активной-недели)
  - [Формат ошибок резолва типа урока](#формат-ошибок-резолва-типа-урока)
- [Личное расписание (My Schedule)](#личное-расписание-my-schedule)
  - [Правила доступа и фильтрации](#правила-доступа-и-фильтрации)
  - [Эндпоинт и параметры](#эндпоинт-и-параметры)
  - [Примеры ответов](#примеры-ответов)
- [Справка по типам уроков (LessonType)](#справка-по-типам-уроков-lessontype)

---

## Черновики недельного шаблона (Draft)

### Модель данных черновика

В БД черновик хранит «снимок» расписания недели пользователем. На фронте работаем с полем `data.lessons` — **плоский список уроков** на неделю.

```ts
type DraftLesson = {
  id?: number;             // необязательный локальный идентификатор строки
  subject: number;         // id предмета
  grade: number;           // id класса
  teacher: number;         // id учителя
  day_of_week: 0|1|2|3|4|5|6; // 0=Пн … 6=Вс
  start_time: string;      // "HH:MM", локальное время
  duration_minutes: number;// длительность в минутах
  // Тип урока можно задать ЛЮБЫМ из трёх способов ниже (любой один):
  type?: { id: number } | { key: string } | { label: string };
};
```

> На коммите сервер **резолвит** `type` к модели `LessonType` и сохраняет ссылку.  
> Если резолв не удался — коммит вернёт **400** с подсказкой и списком доступных типов.

---

### Получить/создать черновик пользователя

```
GET /api/draft/template-drafts/get-or-create/
```

- Возвращает текущий черновик пользователя. Если его нет — создаёт пустой.
- Ответ (усечённый):

```json
{
  "id": 12,
  "user": 3,
  "base_week": 7,
  "data": {
    "lessons": [ /* DraftLesson[] */ ]
  },
  "updated_at": "2025-09-04T12:00:00Z"
}
```

---

### Создать черновик из активного/указанного шаблона

```
POST /api/draft/template-drafts/create-from-template/
Content-Type: application/json
```

Тело (опционально):

```json
{ "template_id": 7 }
```

- Если `template_id` **не передан**, берётся активная неделя (`is_active=True`).
- Старый черновик пользователя удаляется; создаётся новый на основе шаблонной недели.
- Ответ — как у «get-or-create».

---

### Создать пустой черновик

```
POST /api/draft/template-drafts/create-empty/
```

- Удаляет старый черновик пользователя (если был) и создаёт пустой `{"lessons": []}`.
- Ответ — как у «get-or-create».

---

### Обновить черновик

```
PATCH /api/draft/template-drafts/update/
Content-Type: application/json
```

Тело:

```json
{
  "data": {
    "lessons": [ /* DraftLesson[] */ ]
  }
}
```

- Поле `data` **целиком** заменяет текущее содержимое.
- История в `change_history` пополняется предыдущим снимком.
- Ответ — актуальный черновик.

---

### Проверить черновик на коллизии (без коммита)

```
POST /api/draft/template-drafts/validate/
```

Ответ:

```json
{
  "lessons": [ /* исходные DraftLesson[] */ ],
  "collisions": [
    {
      "type": "TEACHER_OVERLAP",
      "resource_id": 42,
      "weekday": 2,
      "lesson_ids": [101, 102],
      "severity": "error",
      "message": "Учитель задействован в двух уроках одновременно"
    }
  ]
}
```

- Состав `collisions` зависит от валидатора (`check_collisions`). Используйте `type/severity/message` для UI.

---

### Проверить существование черновика

```
GET /api/draft/template-drafts/exists/
```

Ответ:

```json
{ "exists": true }
```

---

### Коммит черновика → публикация активной недели

**Вариант A. Коммит собственного черновика (для любого пользователя):**

```
POST /api/draft/template-drafts/commit/
```

**Вариант B. Коммит по id (для владельца или ролей ADMIN/DIRECTOR/HEAD_TEACHER/AUDITOR):**

```
POST /api/draft/template-drafts/{id}/commit/
```

Поведение:
- Все прошлые `TemplateWeek.is_active=True` деактивируются.
- Создаётся **новая активная неделя**. Если не задан `AcademicYear`, сервер создаёт «текущий» год автоматически.
- Для каждого урока из `data.lessons` создаётся `TemplateLesson` с разрешённым типом:
  - Если передан `type.id` — используется он.
  - Иначе сервер пытается сопоставить по `type.key` **или** `type.label` (без учёта регистра для label).
- Успешный ответ: **200 OK**

Пример ответа:
```json
{ "detail": "Черновик опубликован", "week_id": 17 }
```

#### Формат ошибок резолва типа урока

Если тип не найден, придёт 400 с полем `type` и подсказками:

```json
{
  "type": {
    "error": "unknown",
    "given": { "key": "unknown_type" },
    "available": [
      { "id": 1, "key": "lecture",     "label": "Лекция" },
      { "id": 2, "key": "seminar",     "label": "Семинар" },
      { "id": 3, "key": "laboratory",  "label": "Лабораторная" }
    ]
  }
}
```

> Используйте `available` для выпадушки/подсказок на фронте.

---

## Личное расписание (My Schedule)

```
GET /api/real_schedule/my/?from=YYYY-MM-DD&to=YYYY-MM-DD[&children=1,2]
```

### Правила доступа и фильтрации

- **ADMIN / DIRECTOR / HEAD_TEACHER / AUDITOR** — видят всё.
- **TEACHER** — только свои уроки (`teacher_id = me`).
- **STUDENT**:
  - Если `individual_subjects_enabled = true` — видит **только** уроки по своим индивидуальным предметам (классы игнорируются).
  - Иначе — по своим классам (берутся из связей `StudentSubject`).
- **PARENT** — агрегированное расписание по активным детям.
  - Параметр `children=12,34` ограничивает список детей для выборки.

> Если `from/to` не указаны — вернётся **текущая учебная неделя** (по серверной логике).

### Эндпоинт и параметры

Параметры:
- `from` — дата включительно `YYYY-MM-DD`  
- `to` — дата включительно `YYYY-MM-DD` (внутри сервера приводится к полуоткрытому диапазону `[from; to+1)`)
- `children` — CSV id детей (только для родителя)

Коды ошибок:
- 400 — неверный диапазон дат или слишком широкий диапазон.

### Примеры ответов

```json
{
  "from": "2025-09-01",
  "to": "2025-09-07",
  "count": 2,
  "results": [
    {
      "id": 101,
      "subject": { "id": 5, "name": "Математика" },
      "grade":   { "id": 12, "name": "5А" },
      "teacher": { "id": 7, "full_name": "Иванов И.И." },
      "lesson_type": { "id": 1, "key": "lecture", "label": "Лекция" },
      "start": "2025-09-02T09:00:00Z",
      "duration_minutes": 45
    },
    {
      "id": 102,
      "subject": { "id": 6, "name": "Русский язык" },
      "grade":   { "id": 9,  "name": "4А" },
      "teacher": { "id": 7, "full_name": "Иванов И.И." },
      "lesson_type": { "id": 3, "key": "laboratory", "label": "Лабораторная" },
      "start": "2025-09-02T10:00:00Z",
      "duration_minutes": 45
    }
  ]
}
```

---

## Справка по типам уроков (LessonType)

Полезно кэшировать на фронте для подсказок и резолва на клиенте.

```ts
type LessonType = { id: number; key: string; label: string };
```

Обычно доступны типы вида:
- `{ id: 1, key: "lecture", label: "Лекция" }`
- `{ id: 2, key: "seminar", label: "Семинар" }`
- `{ id: 3, key: "laboratory", label: "Лабораторная" }`

> На коммите можно передавать **любой** из вариантов: `type: {id}` **или** `type: {key}` **или** `type: {label}`.
